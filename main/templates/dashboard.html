{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="py-2 md:py-4">
   <!-- User Profile Header -->
<div class="bg-white shadow-lg rounded-2xl py-6 px-4 md:px-6 mb-6 border border-gray-100">
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center space-x-4">
            <!-- Profile Picture -->
            {% if request.user.profile_picture %}
                <img src="{{ request.user.profile_picture.url }}" 
                     alt="Profile Picture" 
                     class="h-14 w-14 rounded-full object-cover border-3 border-gecu-blue shadow-md">
            {% else %}
                <div class="h-14 w-14 rounded-full bg-gradient-to-r from-gecu-navy to-gecu-blue flex items-center justify-center shadow-md">
                    <span class="text-white text-xl font-bold">
                        {{ request.user.full_name|default:"M"|first|upper }}
                    </span>
                </div>
            {% endif %}

            <!-- User Info -->
            <div>
                <h2 class="font-bold text-gray-900 text-lg md:text-xl">
                    Welcome back, {{ request.user.full_name|default:"Member" }}!
                </h2>
                <p class="text-xs text-gray-500 mt-1 flex items-center">
                    <i class="fas fa-clock mr-1"></i>
                    Last login: {{ last_login_time|default:"Recently" }}
                </p>
                
                <!-- KYC Status Badge -->
                {% if not request.user.kyc %}
                    <div class="mt-2 text-xs text-red-700 bg-red-50 rounded-full px-3 py-1.5 inline-flex items-center border border-red-200">
                        <i class="fas fa-exclamation-triangle mr-1.5"></i>
                        KYC Required
                    </div>
                {% elif request.user.kyc_status == "pending" %}
                    <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded-full px-3 py-1.5 inline-flex items-center border border-yellow-200">
                        <i class="fas fa-hourglass-half mr-1.5"></i>
                        KYC Pending
                    </div>
                {% elif request.user.kyc_status == "approved" %}
                    <div class="mt-2 text-xs text-green-700 bg-green-50 rounded-full px-3 py-1.5 inline-flex items-center border border-green-200">
                        <i class="fas fa-check-circle mr-1.5"></i>
                        Verified Account
                    </div>
                {% elif request.user.kyc_status == "rejected" %}
                    <div class="mt-2 text-xs text-red-700 bg-red-50 rounded-full px-3 py-1.5 inline-flex items-center border border-red-200">
                        <i class="fas fa-times-circle mr-1.5"></i>
                        KYC Rejected
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Button -->
        <div>
            {% if not request.user.kyc or request.user.kyc_status == "rejected" %}
                <a href="{% url 'kyc_verification' %}" 
                   class="inline-flex items-center px-4 py-2 text-sm font-semibold rounded-full shadow-lg text-white bg-gradient-to-r from-gecu-navy to-gecu-blue hover:shadow-xl transition-all transform hover:scale-105">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Complete KYC
                </a>
            {% endif %}
        </div>
    </div>
</div>

    <!-- Swipeable Account Cards -->
    <div class="relative mb-6 px-2" id="wallets-container">
        <div class="account-carousel flex overflow-x-auto space-x-4 py-4 px-2 hide-scrollbar" id="wallets-carousel">
            {% for wallet in wallets_json %}
            <div class="relative account-card flex-shrink-0 w-72 md:w-80 wallet-card shadow-2xl"
                 data-index="{{ forloop.counter0 }}"
                 data-number="{{ wallet.number }}"
                 data-active="{{ wallet.is_active|yesno:'true,false' }}"
                 style="{% if not wallet.is_active %}opacity: 0.7;{% endif %}">
                
                <!-- Background gradient -->
                <div class="absolute inset-0 rounded-2xl overflow-hidden 
                    {% if wallet.type == 'checking' %}bg-gradient-to-br from-gecu-navy via-gecu-blue to-gecu-navy
                    {% elif wallet.type == 'savings' %}bg-gradient-to-br from-green-600 via-green-500 to-green-600
                    {% else %}bg-gradient-to-br from-purple-600 via-purple-500 to-purple-600{% endif %}">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
                    <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
                </div>

                {% if not wallet.is_active %}
                <div class="absolute inset-0 z-50 bg-gray-900 bg-opacity-95 text-white flex flex-col items-center justify-center p-6 rounded-2xl border-4 border-red-500">
                    <i class="fas fa-lock text-5xl mb-4 text-red-500"></i>
                    <p class="text-xl font-bold mb-3">Account Frozen</p>
                    <p class="text-sm text-gray-300 mb-4 text-center">Unusual activity detected</p>
                    <a href="mailto:support@grandelitecreditunion.com" 
                       class="text-sm font-semibold text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full">
                        Contact Support
                    </a>
                </div>
                {% endif %}

                <!-- Card content -->
                <div class="relative z-20 p-6 text-white h-full flex flex-col min-h-[200px]">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <p class="text-xs uppercase tracking-wider opacity-80 mb-1">{{ wallet.type }}</p>
                            <h3 class="font-bold text-lg">{{ wallet.name }}</h3>
                            <p class="text-sm opacity-90 mt-2 wallet-number font-mono">
                                <span class="partial-number">•••• •••• •••• </span>
                                <span class="full-number hidden">{{ wallet.number }}</span>
                            </p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas text-lg
                                {% if wallet.type == 'checking' %}fa-credit-card
                                {% elif wallet.type == 'savings' %}fa-piggy-bank
                                {% else %}fa-chart-line{% endif %}"></i>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <p class="text-xs uppercase tracking-wider opacity-80 mb-1">Available Balance</p>
                        <p class="text-3xl font-bold mb-1">{{ wallet.balance }}</p>
                        <p class="text-xs opacity-80">{{ wallet.trend }}</p>
                    </div>
                    <div class="mt-6 pt-4 border-t border-white border-opacity-20">
                        <div class="flex justify-between items-center">
                            <div class="relative">
                                <button class="text-xs font-medium toggle-number-btn flex items-center space-x-1">
                                    <i class="fas fa-eye show-icon"></i>
                                    <i class="fas fa-eye-slash hide-icon hidden"></i>
                                    <span class="show-text">Show</span>
                                    <span class="hide-text hidden">Hide</span>
                                </button>
                                <div class="copied-message absolute -top-8 left-0 bg-white text-gray-800 text-xs px-3 py-1 rounded shadow-lg hidden">
                                    Copied!
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="copy-btn bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-2" title="Copy number">
                                    <i class="fas fa-copy text-sm"></i>
                                </button>
                                <button class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-2">
                                    <i class="fas fa-ellipsis-h text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Dots indicator -->
        <div class="flex justify-center mt-4 space-x-2" id="wallets-dots">
            {% for wallet in wallets_json %}
            <button class="h-2.5 rounded-full wallet-dot transition-all {% if forloop.first %}bg-gecu-navy w-8{% else %}bg-gray-300 w-2.5{% endif %}"
                    data-index="{{ forloop.counter0 }}"></button>
            {% endfor %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-4 gap-3 mb-6 px-2">
        <a href="{% url 'transfer' %}" class="bg-white rounded-2xl shadow-md hover:shadow-xl p-4 flex flex-col items-center card-hover">
            <div class="bg-gradient-to-br from-gecu-navy to-gecu-blue text-white rounded-2xl p-3 mb-3">
                <i class="fas fa-paper-plane text-lg"></i>
            </div>
            <span class="text-xs font-semibold text-gray-700">Transfer</span>
        </a>
        <a href="{% url 'deposit' %}" class="bg-white rounded-2xl shadow-md hover:shadow-xl p-4 flex flex-col items-center card-hover">
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-2xl p-3 mb-3">
                <i class="fas fa-money-bill-wave text-lg"></i>
            </div>
            <span class="text-xs font-semibold text-gray-700">Deposit</span>
        </a>
        <a href="{% url 'withdrawals' %}" class="bg-white rounded-2xl shadow-md hover:shadow-xl p-4 flex flex-col items-center card-hover">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl p-3 mb-3">
                <i class="fas fa-wallet text-lg"></i>
            </div>
            <span class="text-xs font-semibold text-gray-700">Withdraw</span>
        </a>
        <a href="{% url 'loans' %}" class="bg-white rounded-2xl shadow-md hover:shadow-xl p-4 flex flex-col items-center card-hover">
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-2xl p-3 mb-3">
                <i class="fas fa-hand-holding-usd text-lg"></i>
            </div>
            <span class="text-xs font-semibold text-gray-700">Loans</span>
        </a>
    </div>

    <!-- Recent Transactions -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-gecu-navy to-gecu-blue text-white flex justify-between items-center">
            <h3 class="text-lg font-bold">Recent Transactions</h3>
            <a href="{% url 'transactions' %}" class="text-white text-sm font-semibold bg-white bg-opacity-20 px-4 py-1.5 rounded-full hover:bg-opacity-30 transition">
                See All
            </a>
        </div>
        <div class="divide-y divide-gray-200">
            {% for transaction in recent_transactions %}
            <div class="px-6 py-4 hover:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="{% if transaction.transaction_type == 'DEBIT' %}bg-red-100 text-red-600{% else %}bg-green-100 text-green-600{% endif %} rounded-xl p-3 mr-4">
                            <i class="fas {% if transaction.transaction_type == 'DEBIT' %}fa-arrow-down{% else %}fa-arrow-up{% endif %} text-lg"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900">{{ transaction.description }}</h4>
                            <p class="text-sm text-gray-500 mt-1">
                                {{ transaction.created_at|date:"M d, h:i A" }} • 
                                {{ transaction.wallet.get_account_type_display }} ••••{{ transaction.wallet.account_number|slice:"-4:" }}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg {% if transaction.transaction_type == 'DEBIT' %}text-red-600{% else %}text-green-600{% endif %}">
                            {% if transaction.transaction_type == 'DEBIT' %}-{% else %}+{% endif %}${{ transaction.amount|floatformat:2 }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">{{ transaction.get_status_display }}</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-12 text-center">
                <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">No recent transactions</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .account-carousel {
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
    .account-card {
        scroll-snap-align: start;
        flex: 0 0 80%;
        margin-right: 1rem;
        border-radius: 1rem;
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .card-hover {
        transition: all 0.3s ease;
    }
    .card-hover:hover {
        transform: translateY(-4px);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('wallets-carousel');
    const dots = document.querySelectorAll('.wallet-dot');
    let currentIndex = 0;
    
    function updateDots(index) {
        dots.forEach((dot, i) => {
            if (i === index) {
                dot.classList.remove('bg-gray-300', 'w-2.5');
                dot.classList.add('bg-gecu-navy', 'w-8');
            } else {
                dot.classList.remove('bg-gecu-navy', 'w-8');
                dot.classList.add('bg-gray-300', 'w-2.5');
            }
        });
    }
    
    dots.forEach(dot => {
        dot.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            currentIndex = index;
            scrollToCard(index);
            updateDots(index);
        });
    });
    
    function scrollToCard(index) {
        const cards = document.querySelectorAll('.wallet-card');
        if (cards[index]) {
            cards[index].scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'start'
            });
        }
    }
    
    carousel.addEventListener('scroll', function() {
        const cards = document.querySelectorAll('.wallet-card');
        let closestCard = null;
        let closestDistance = Infinity;
        
        cards.forEach((card, index) => {
            const rect = card.getBoundingClientRect();
            const distance = Math.abs(rect.left - carousel.getBoundingClientRect().left);
            
            if (distance < closestDistance) {
                closestDistance = distance;
                closestCard = index;
            }
        });
        
        if (closestCard !== null && closestCard !== currentIndex) {
            currentIndex = closestCard;
            updateDots(currentIndex);
        }
    });
    
    document.querySelectorAll('.toggle-number-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const card = this.closest('.wallet-card');
            const showIcon = card.querySelector('.show-icon');
            const hideIcon = card.querySelector('.hide-icon');
            const showText = card.querySelector('.show-text');
            const hideText = card.querySelector('.hide-text');
            const partialNumber = card.querySelector('.partial-number');
            const fullNumber = card.querySelector('.full-number');
            
            if (showIcon.classList.contains('hidden')) {
                showIcon.classList.remove('hidden');
                hideIcon.classList.add('hidden');
                showText.classList.remove('hidden');
                hideText.classList.add('hidden');
                partialNumber.classList.remove('hidden');
                fullNumber.classList.add('hidden');
            } else {
                showIcon.classList.add('hidden');
                hideIcon.classList.remove('hidden');
                showText.classList.add('hidden');
                hideText.classList.remove('hidden');
                partialNumber.classList.add('hidden');
                fullNumber.classList.remove('hidden');
            }
        });
    });
    
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const card = this.closest('.wallet-card');
            const accountNumber = card.getAttribute('data-number');
            const copiedMessage = card.querySelector('.copied-message');
            
            navigator.clipboard.writeText(accountNumber).then(() => {
                copiedMessage.classList.remove('hidden');
                setTimeout(() => {
                    copiedMessage.classList.add('hidden');
                }, 2000);
            });
        });
    });
});
</script>

{% endblock %}